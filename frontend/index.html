<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAXbuddy - Платформа заявок</title>
    <style>
        :root {
            --primary-color: #6a11cb;
            --secondary-color: #2575fc;
            --accent-color: #8a2be2;
            --light-bg: #f8f9ff;
            --dark-text: #333;
            --light-text: #fff;
            --shadow: 0 4px 12px rgba(106, 17, 203, 0.15);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--dark-text);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--light-text);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--primary-color);
            box-shadow: var(--shadow);
        }
        
        .logo-text {
            font-size: 24px;
            font-weight: bold;
            color: var(--light-text);
        }
        
        .auth-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }
        
        .btn-primary {
            background: var(--light-text);
            color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--light-text);
            border: 2px solid var(--light-text);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .btn-dark {
            background: var(--primary-color);
            color: var(--light-text);
        }
        
        .btn-dark:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .hero {
            text-align: center;
            padding: 40px 0;
            color: var(--light-text);
            margin-bottom: 40px;
        }
        
        .hero h1 {
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .hero p {
            font-size: 20px;
            max-width: 700px;
            margin: 0 auto 30px;
            line-height: 1.6;
        }
        
        .requests-section {
            background: var(--light-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 24px;
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .requests-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .request-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            position: relative;
        }
        
        .request-card:hover {
            transform: translateY(-5px);
        }
        
        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
        }
        
        .user-institute {
            font-weight: 600;
            color: var(--dark-text);
            font-size: 16px;
        }
        
        .user-course {
            font-size: 14px;
            color: #666;
        }
        
        .request-date {
            font-size: 12px;
            color: #888;
        }
        
        .request-content {
            margin-bottom: 15px;
            line-height: 1.5;
            padding-right: 100px;
        }
        
        .request-actions {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        .btn-contact {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 8px 15px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .btn-contact:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .btn-delete {
            background: #ff4757;
            color: white;
            padding: 8px 15px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .btn-delete:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .show-more {
            text-align: center;
            margin-top: 20px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #888;
        }
        
        .modal-header {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .modal-title {
            font-size: 28px;
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .modal-requests {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .auth-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            padding: 30px;
            text-align: center;
        }
        
        .auth-title {
            font-size: 24px;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .auth-description {
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .auth-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .auth-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .auth-btn:hover {
            opacity: 0.9;
        }
        
        .create-request-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .create-request-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            padding: 30px;
            position: relative;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            resize: vertical;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1001;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification-success {
            border-left: 4px solid #4CAF50;
        }
        
        .notification-error {
            border-left: 4px solid #f44336;
        }
        
        .notification-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .notification-success .notification-icon {
            background: #4CAF50;
        }
        
        .notification-error .notification-icon {
            background: #f44336;
        }
        
        .no-requests {
            text-align: center;
            padding: 40px;
            color: #888;
            font-style: italic;
        }
        
        footer {
            text-align: center;
            padding: 20px 0;
            color: var(--light-text);
            font-size: 14px;
        }
        
        .validation-error {
            color: #ff4757;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 36px;
            }
            
            .hero p {
                font-size: 18px;
            }
            
            .section-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .auth-section {
                flex-direction: column;
                gap: 10px;
            }
            
            .request-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .request-content {
                padding-right: 0;
                margin-bottom: 50px;
            }
            
            .request-actions {
                position: static;
                justify-content: flex-end;
                margin-top: 10px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">M</div>
                <div class="logo-text">MAXbuddy</div>
            </div>
            <div class="auth-section">
                <button class="btn btn-secondary" id="loginBtn">Войти через MAX</button>
                <button class="btn btn-primary" id="createRequestBtn" style="display: none;">Разместить заявку</button>
                <button class="btn btn-secondary" id="logoutBtn" style="display: none;">Выйти</button>
            </div>
        </header>
        
        <section class="hero">
            <h1>Найдите помощь с MAXbuddy</h1>
            <p>Платформа для поиска помощи и сотрудничества через мессенджер MAX. Разместите свою заявку или помогите другим пользователям!</p>
        </section>
        
        <section class="requests-section">
            <div class="section-header">
                <h2 class="section-title">Активные заявки</h2>
                <div id="requestsCount">Загрузка...</div>
            </div>
            
            <div class="requests-list" id="requestsList">
                <div class="no-requests">Загрузка заявок...</div>
            </div>
            
            <div class="show-more" id="showMoreSection" style="display: none;">
                <button class="btn btn-dark" id="showMoreBtn">Показать все заявки</button>
            </div>
        </section>
    </div>
    
    <!-- Модальное окно со всеми заявками -->
    <div class="modal" id="requestsModal">
        <div class="modal-content">
            <span class="close-modal" id="closeModal">&times;</span>
            <div class="modal-header">
                <h2 class="modal-title">Все заявки</h2>
            </div>
            <div class="modal-requests" id="modalRequests">
                <div class="no-requests">Загрузка заявок...</div>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно авторизации -->
    <div class="auth-modal" id="authModal">
        <div class="auth-content">
            <h2 class="auth-title">Авторизация через MAX</h2>
            <p class="auth-description">Для размещения заявок и доступа ко всем функциям сайта, пожалуйста, авторизуйтесь через ваш аккаунт в мессенджере MAX.</p>
            <input type="text" class="auth-input" id="maxLink" placeholder="Введите ссылку на ваш профиль в MAX (https://max.ru/u/...)">
            <div class="validation-error" id="linkValidationError">Ссылка должна быть формата https://max.ru/u/username</div>
            <button class="auth-btn" id="authConfirmBtn">Авторизоваться</button>
        </div>
    </div>
    
    <!-- Модальное окно создания заявки -->
    <div class="create-request-modal" id="createRequestModal">
        <div class="create-request-content">
            <span class="close-modal" id="closeCreateRequestModal">&times;</span>
            <div class="modal-header">
                <h2 class="modal-title">Разместить новую заявку</h2>
            </div>
            <div class="form-group">
                <label class="form-label" for="requestInstitute">Институт</label>
                <input type="text" class="form-control" id="requestInstitute" placeholder="Введите ваш институт">
            </div>
            <div class="form-group">
                <label class="form-label" for="requestCourse">Курс</label>
                <input type="text" class="form-control" id="requestCourse" placeholder="Введите ваш курс">
            </div>
            <div class="form-group">
                <label class="form-label" for="requestText">Текст заявки</label>
                <textarea class="form-control" id="requestText" placeholder="Опишите, какая помощь вам нужна..." rows="4"></textarea>
            </div>
            <button class="auth-btn" id="submitRequestBtn">Опубликовать заявку</button>
        </div>
    </div>
    
    <!-- Уведомления -->
    <div class="notification notification-success" id="successNotification">
        <div class="notification-icon">✓</div>
        <div class="notification-text">Операция выполнена успешно!</div>
    </div>
    
    <div class="notification notification-error" id="errorNotification">
        <div class="notification-icon">!</div>
        <div class="notification-text">Произошла ошибка!</div>
    </div>
    
    <footer>
        <p>MAXbuddy &copy; 2023 - Платформа для поиска помощи через мессенджер MAX</p>
    </footer>

    <script>
        // Конфигурация API
        const API_BASE_URL = 'http://localhost:3000/api';
        
        // Состояние приложения
        let isAuthenticated = false;
        let currentUser = null;
        let requests = [];
        let users = [];
        const maxRequestsToShow = 3;
        
        // Элементы DOM
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const createRequestBtn = document.getElementById('createRequestBtn');
        const showMoreBtn = document.getElementById('showMoreBtn');
        const showMoreSection = document.getElementById('showMoreSection');
        const requestsList = document.getElementById('requestsList');
        const modalRequests = document.getElementById('modalRequests');
        const requestsModal = document.getElementById('requestsModal');
        const closeModal = document.getElementById('closeModal');
        const authModal = document.getElementById('authModal');
        const authConfirmBtn = document.getElementById('authConfirmBtn');
        const maxLinkInput = document.getElementById('maxLink');
        const linkValidationError = document.getElementById('linkValidationError');
        const createRequestModal = document.getElementById('createRequestModal');
        const closeCreateRequestModal = document.getElementById('closeCreateRequestModal');
        const submitRequestBtn = document.getElementById('submitRequestBtn');
        const requestInstitute = document.getElementById('requestInstitute');
        const requestCourse = document.getElementById('requestCourse');
        const requestText = document.getElementById('requestText');
        const requestsCount = document.getElementById('requestsCount');
        const successNotification = document.getElementById('successNotification');
        const errorNotification = document.getElementById('errorNotification');
        
        // Функция для проверки валидности ссылки MAX
        function isValidMaxLink(link) {
            const pattern = /^https:\/\/max\.ru\/u\/[a-zA-Z0-9_-]+$/;
            return pattern.test(link);
        }
        
        // Функция для извлечения имени пользователя из ссылки
        function extractUsernameFromLink(link) {
            const parts = link.split('/');
            return parts[parts.length - 1];
        }
        
        // API функции
        async function fetchRequests() {
            try {
                const response = await fetch(`${API_BASE_URL}/requests`);
                if (response.ok) {
                    return await response.json();
                } else {
                    throw new Error('Ошибка при загрузке заявок');
                }
            } catch (error) {
                console.error('Error fetching requests:', error);
                showNotification(errorNotification, 'Ошибка при загрузке заявок');
                return [];
            }
        }
        
        async function fetchUsers() {
            try {
                const response = await fetch(`${API_BASE_URL}/users`);
                if (response.ok) {
                    return await response.json();
                } else {
                    throw new Error('Ошибка при загрузке пользователей');
                }
            } catch (error) {
                console.error('Error fetching users:', error);
                return [];
            }
        }
        
        async function createRequest(requestData) {
            try {
                const response = await fetch(`${API_BASE_URL}/requests`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData),
                });
                
                if (response.ok) {
                    return await response.json();
                } else {
                    throw new Error('Ошибка при создании заявки');
                }
            } catch (error) {
                console.error('Error creating request:', error);
                throw error;
            }
        }
        
        async function deleteRequest(requestId) {
            try {
                const response = await fetch(`${API_BASE_URL}/requests/${requestId}`, {
                    method: 'DELETE',
                });
                
                if (response.ok) {
                    return true;
                } else {
                    throw new Error('Ошибка при удалении заявки');
                }
            } catch (error) {
                console.error('Error deleting request:', error);
                throw error;
            }
        }
        
        // Функция для отображения заявок
        function displayRequests(container, requestsToShow) {
            container.innerHTML = '';
            
            if (requestsToShow.length === 0) {
                container.innerHTML = '<div class="no-requests">Пока нет активных заявок</div>';
                return;
            }
            
            requestsToShow.forEach(request => {
                const user = users.find(u => u.id === request.userId);
                if (!user) return;
                
                const requestElement = document.createElement('div');
                requestElement.className = 'request-card';
                
                // Проверяем, принадлежит ли заявка текущему пользователю
                // Теперь проверяем по maxLink, а не по id пользователя
                const isOwnRequest = isAuthenticated && currentUser && 
                    (request.userId === currentUser.id || user.maxLink === currentUser.maxLink);
                
                requestElement.innerHTML = `
                    <div class="request-header">
                        <div class="user-info">
                            <div class="user-avatar">${user.institute ? user.institute.charAt(0) : 'И'}</div>
                            <div class="user-details">
                                <div class="user-institute">${user.institute || 'Институт'}</div>
                                <div class="user-course">${user.course || 'Курс'}</div>
                            </div>
                        </div>
                        <div class="request-date">${formatDate(request.date)}</div>
                    </div>
                    <div class="request-content">
                        ${request.text}
                    </div>
                    <div class="request-actions">
                        <button class="btn-contact" data-maxlink="${user.maxLink}">Перейти в личные сообщения</button>
                        ${isOwnRequest ? `<button class="btn-delete" data-request-id="${request.id}">Удалить</button>` : ''}
                    </div>
                `;
                
                container.appendChild(requestElement);
            });
            
            // Добавляем обработчики событий для кнопок контакта
            const contactBtns = container.querySelectorAll('.btn-contact');
            contactBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const maxLink = this.getAttribute('data-maxlink');
                    window.open(maxLink, '_blank');
                });
            });
            
            // Добавляем обработчики событий для кнопок удаления
            const deleteBtns = container.querySelectorAll('.btn-delete');
            deleteBtns.forEach(btn => {
                btn.addEventListener('click', async function() {
                    const requestId = this.getAttribute('data-request-id');
                    if (confirm('Вы уверены, что хотите удалить эту заявку?')) {
                        try {
                            await deleteRequest(requestId);
                            // Обновляем локальные данные
                            requests = requests.filter(r => r.id !== requestId);
                            updateUI();
                            showNotification(successNotification, 'Заявка успешно удалена');
                        } catch (error) {
                            showNotification(errorNotification, 'Ошибка при удалении заявки');
                        }
                    }
                });
            });
        }
        
        // Функция для форматирования даты
        function formatDate(dateString) {
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            return new Date(dateString).toLocaleDateString('ru-RU', options);
        }
        
        // Функция для обновления интерфейса в зависимости от состояния авторизации
        function updateUI() {
            if (isAuthenticated) {
                loginBtn.style.display = 'none';
                createRequestBtn.style.display = 'block';
                logoutBtn.style.display = 'block';
            } else {
                loginBtn.style.display = 'block';
                createRequestBtn.style.display = 'none';
                logoutBtn.style.display = 'none';
            }
            
            // Обновляем отображение заявок
            const limitedRequests = requests.slice(0, maxRequestsToShow);
            displayRequests(requestsList, limitedRequests);
            
            // Обновляем счетчик заявок
            if (requests.length === 0) {
                requestsCount.textContent = 'Заявок пока нет';
                showMoreSection.style.display = 'none';
            } else {
                requestsCount.textContent = `Показано ${Math.min(limitedRequests.length, maxRequestsToShow)} из ${requests.length} заявок`;
                showMoreSection.style.display = requests.length > maxRequestsToShow ? 'block' : 'none';
            }
        }
        
        // Функция для показа уведомления
        function showNotification(notification, message) {
            notification.querySelector('.notification-text').textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Функция для загрузки данных
        async function loadData() {
            requests = await fetchRequests();
            users = await fetchUsers();
            updateUI();
        }
        
        // Инициализация приложения
        function init() {
            // Загружаем данные при старте
            loadData();
            
            // Обработчики событий
            loginBtn.addEventListener('click', function() {
                authModal.style.display = 'flex';
            });
            
            logoutBtn.addEventListener('click', function() {
                isAuthenticated = false;
                currentUser = null;
                updateUI();
                showNotification(successNotification, 'Вы успешно вышли из системы');
            });
            
            maxLinkInput.addEventListener('input', function() {
                if (isValidMaxLink(this.value)) {
                    linkValidationError.style.display = 'none';
                } else {
                    linkValidationError.style.display = 'block';
                }
            });
            
            authConfirmBtn.addEventListener('click', function() {
                const maxLink = maxLinkInput.value.trim();
                if (maxLink) {
                    if (isValidMaxLink(maxLink)) {
                        // Ищем пользователя с таким maxLink
                        const existingUser = users.find(u => u.maxLink === maxLink);
                        
                        if (existingUser) {
                            // Используем существующего пользователя
                            currentUser = existingUser;
                        } else {
                            // Создаем нового пользователя
                            const username = extractUsernameFromLink(maxLink);
                            currentUser = {
                                id: Date.now().toString(),
                                name: username.charAt(0).toUpperCase() + username.slice(1),
                                maxLink: maxLink,
                                institute: '',
                                course: ''
                            };
                        }
                        
                        isAuthenticated = true;
                        authModal.style.display = 'none';
                        maxLinkInput.value = '';
                        linkValidationError.style.display = 'none';
                        updateUI();
                        showNotification(successNotification, 'Авторизация прошла успешно! Теперь вы можете размещать заявки.');
                    } else {
                        showNotification(errorNotification, 'Ссылка должна быть формата https://max.ru/u/username');
                    }
                } else {
                    showNotification(errorNotification, 'Пожалуйста, введите ссылку на ваш профиль в MAX.');
                }
            });
            
            createRequestBtn.addEventListener('click', function() {
                // Заполняем поля института и курса, если они уже есть у пользователя
                if (currentUser.institute) {
                    requestInstitute.value = currentUser.institute;
                }
                if (currentUser.course) {
                    requestCourse.value = currentUser.course;
                }
                createRequestModal.style.display = 'flex';
            });
            
            submitRequestBtn.addEventListener('click', async function() {
                const institute = requestInstitute.value.trim();
                const course = requestCourse.value.trim();
                const text = requestText.value.trim();
                
                if (institute && course && text) {
                    try {
                        // Обновляем данные пользователя
                        currentUser.institute = institute;
                        currentUser.course = course;
                        
                        const requestData = {
                            userId: currentUser.id,
                            userName: currentUser.name,
                            userMaxLink: currentUser.maxLink,
                            userInstitute: currentUser.institute,
                            userCourse: currentUser.course,
                            text: text
                        };
                        
                        const newRequest = await createRequest(requestData);
                        
                        // Обновляем локальные данные
                        requests.unshift(newRequest);
                        if (!users.find(u => u.id === currentUser.id)) {
                            users.push({
                                id: currentUser.id,
                                name: currentUser.name,
                                maxLink: currentUser.maxLink,
                                institute: currentUser.institute,
                                course: currentUser.course
                            });
                        } else {
                            // Обновляем существующего пользователя
                            const userIndex = users.findIndex(u => u.id === currentUser.id);
                            if (userIndex !== -1) {
                                users[userIndex].institute = currentUser.institute;
                                users[userIndex].course = currentUser.course;
                            }
                        }
                        
                        // Обновляем отображение заявок
                        updateUI();
                        
                        // Закрываем модальное окно и очищаем поле ввода
                        createRequestModal.style.display = 'none';
                        requestText.value = '';
                        
                        showNotification(successNotification, 'Ваша заявка успешно размещена!');
                    } catch (error) {
                        showNotification(errorNotification, 'Ошибка при создании заявки');
                    }
                } else {
                    showNotification(errorNotification, 'Пожалуйста, заполните все поля.');
                }
            });
            
            showMoreBtn.addEventListener('click', function() {
                // Показываем модальное окно со всеми заявками
                displayRequests(modalRequests, requests);
                requestsModal.style.display = 'flex';
            });
            
            closeModal.addEventListener('click', function() {
                requestsModal.style.display = 'none';
            });
            
            closeCreateRequestModal.addEventListener('click', function() {
                createRequestModal.style.display = 'none';
            });
            
            // Закрытие модальных окон при клике вне их содержимого
            window.addEventListener('click', function(event) {
                if (event.target === requestsModal) {
                    requestsModal.style.display = 'none';
                }
                if (event.target === authModal) {
                    authModal.style.display = 'none';
                }
                if (event.target === createRequestModal) {
                    createRequestModal.style.display = 'none';
                }
            });
        }
        
        // Запуск приложения
        init();
    </script>
</body>
</html>